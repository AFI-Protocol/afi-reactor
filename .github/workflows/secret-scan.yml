name: Secret Scan

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

permissions:
  contents: read

jobs:
  gitleaks:
    name: Scan for Secrets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive scanning

      - name: Run Gitleaks (if license available)
        if: ${{ secrets.GITLEAKS_LICENSE != '' }}
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: Run basic secret scan (fallback)
        if: ${{ secrets.GITLEAKS_LICENSE == '' }}
        run: |
          echo "üîç Running basic secret scan (Gitleaks license not configured)..."
          echo "‚ÑπÔ∏è  For full scanning, add GITLEAKS_LICENSE secret to repository settings"
          echo ""

          # Patterns to detect
          FOUND=0

          # MongoDB connection strings with credentials
          if git log --all -p | grep -E "mongodb(\+srv)?://[^:]+:[^@]+@" | grep -v "username:password"; then
            echo "‚ùå Found MongoDB connection string with credentials"
            FOUND=1
          fi

          # Generic passwords in URLs
          if git log --all -p | grep -E "://[^:]+:[^@]{8,}@" | grep -v "username:password" | grep -v "user:pass"; then
            echo "‚ùå Found URL with embedded credentials"
            FOUND=1
          fi

          # AWS keys
          if git log --all -p | grep -E "AKIA[0-9A-Z]{16}"; then
            echo "‚ùå Found potential AWS access key"
            FOUND=1
          fi

          # Private keys
          if git log --all -p | grep -E "-----BEGIN (RSA |EC |OPENSSH )?PRIVATE KEY-----"; then
            echo "‚ùå Found private key"
            FOUND=1
          fi

          if [ $FOUND -eq 1 ]; then
            echo ""
            echo "‚ö†Ô∏è  Potential secrets detected in git history!"
            echo "Please review and remove any hardcoded credentials."
            echo "See SECURITY.md for guidance."
            exit 1
          fi

          echo "‚úÖ No obvious secrets detected"

      - name: Upload Gitleaks Report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: gitleaks-report.json
          retention-days: 30
          if-no-files-found: ignore

