name: Secret Scan

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

permissions:
  contents: read

jobs:
  gitleaks:
    name: Scan for Secrets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run basic secret scan
        run: |
          echo "üîç Running basic secret scan on tracked files..."
          echo "‚ÑπÔ∏è  Note: This scans current working tree only, not git history"
          echo "‚ÑπÔ∏è  For advanced scanning with Gitleaks, add GITLEAKS_LICENSE secret"
          echo ""

          # Patterns to detect
          FOUND=0

          # Get all tracked files (excluding node_modules, dist, build, .git)
          FILES=$(git ls-files | grep -v "^node_modules/" | grep -v "^dist/" | grep -v "^build/" | grep -v "\.map$")

          # MongoDB connection strings with credentials (excluding placeholders)
          if echo "$FILES" | xargs grep -h -E "mongodb(\+srv)?://[^:]+:[^@]+@" 2>/dev/null | grep -v "username:password" | grep -v "<password>" | grep -v "\${string}" | grep -v "YOUR_PASSWORD" | grep -v "afi_app:<password>"; then
            echo "‚ùå Found MongoDB connection string with credentials in tracked files"
            FOUND=1
          fi

          # Generic passwords in URLs (excluding placeholders)
          if echo "$FILES" | xargs grep -h -E "://[^:]+:[^@]{8,}@" 2>/dev/null | grep -v "username:password" | grep -v "user:pass" | grep -v "<password>" | grep -v "\${string}" | grep -v "YOUR_PASSWORD" | grep -v '\$DB_' | grep -v '\$\{' | grep -v "example.com" | grep -v "localhost"; then
            echo "‚ùå Found URL with embedded credentials in tracked files"
            FOUND=1
          fi

          # AWS keys
          if echo "$FILES" | xargs grep -h -E "AKIA[0-9A-Z]{16}" 2>/dev/null; then
            echo "‚ùå Found potential AWS access key in tracked files"
            FOUND=1
          fi

          # Private keys (excluding example/placeholder keys)
          if echo "$FILES" | xargs grep -h -E "-----BEGIN (RSA |EC |OPENSSH )?PRIVATE KEY-----" 2>/dev/null | grep -v "EXAMPLE" | grep -v "PLACEHOLDER"; then
            echo "‚ùå Found private key in tracked files"
            FOUND=1
          fi

          if [ $FOUND -eq 1 ]; then
            echo ""
            echo "‚ö†Ô∏è  Potential secrets detected in tracked files!"
            echo "Please review and remove any hardcoded credentials."
            echo "See SECURITY.md for guidance."
            exit 1
          fi

          echo "‚úÖ No secrets detected in tracked files"

