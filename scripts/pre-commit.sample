#!/bin/bash
#
# AFI Reactor Pre-Commit Hook - Secret Scanner
#
# This hook scans staged files for potential secrets before allowing a commit.
# It uses simple regex patterns to catch common secret patterns.
#
# Installation:
#   cp scripts/pre-commit.sample .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# To bypass (use sparingly):
#   git commit --no-verify
#

set -e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo "ğŸ” Scanning for secrets in staged files..."

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
  echo "${GREEN}âœ“ No files to scan${NC}"
  exit 0
fi

# Secret patterns to detect
PATTERNS=(
  # MongoDB connection strings with credentials
  "mongodb(\+srv)?://[^:]+:[^@]+@"
  
  # Generic passwords in URLs
  "://[^:]+:[^@]{8,}@"
  
  # AWS keys
  "AKIA[0-9A-Z]{16}"
  
  # Generic API keys (common patterns)
  "api[_-]?key['\"]?\s*[:=]\s*['\"][a-zA-Z0-9_\-]{20,}['\"]"
  
  # Generic secrets/tokens
  "secret['\"]?\s*[:=]\s*['\"][a-zA-Z0-9_\-]{20,}['\"]"
  "token['\"]?\s*[:=]\s*['\"][a-zA-Z0-9_\-]{20,}['\"]"
  
  # Private keys
  "-----BEGIN (RSA |EC |OPENSSH )?PRIVATE KEY-----"
  
  # Generic password assignments
  "password['\"]?\s*[:=]\s*['\"][^'\"]{8,}['\"]"
)

FOUND_SECRETS=0

# Scan each staged file
for FILE in $STAGED_FILES; do
  # Skip binary files and certain extensions
  if [[ "$FILE" =~ \.(jpg|jpeg|png|gif|pdf|zip|tar|gz|exe|dll|so|dylib)$ ]]; then
    continue
  fi
  
  # Skip node_modules and dist
  if [[ "$FILE" =~ ^(node_modules|dist)/ ]]; then
    continue
  fi
  
  # Check each pattern
  for PATTERN in "${PATTERNS[@]}"; do
    if git diff --cached "$FILE" | grep -iE "$PATTERN" > /dev/null; then
      echo "${RED}âœ— Potential secret found in: $FILE${NC}"
      echo "${YELLOW}  Pattern: $PATTERN${NC}"
      FOUND_SECRETS=1
    fi
  done
done

if [ $FOUND_SECRETS -eq 1 ]; then
  echo ""
  echo "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo "${RED}âš ï¸  COMMIT BLOCKED: Potential secrets detected!${NC}"
  echo "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  echo "Please review the files above and:"
  echo "  1. Remove any hardcoded credentials"
  echo "  2. Use environment variables instead (see .env.example)"
  echo "  3. Add sensitive files to .gitignore if needed"
  echo ""
  echo "If this is a false positive, you can bypass with:"
  echo "  ${YELLOW}git commit --no-verify${NC}"
  echo ""
  echo "See SECURITY.md for more information."
  echo ""
  exit 1
fi

echo "${GREEN}âœ“ No secrets detected${NC}"
exit 0

